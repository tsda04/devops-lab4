name: CD Pipeline with Docker

on:
  release:
    types: [published]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: docker-lab3  # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ç–∫—É
      
    - name: Deploy to server with Docker
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "Starting Docker deployment..."
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ç–∫–∏
          echo "Updating code from docker-lab3 branch..."
          cd /home/${{ secrets.SSH_USER }}/devops-lab-tsyganova
          git fetch origin
          git checkout docker-lab3
          git reset --hard origin/docker-lab3
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π systemd —Å–µ—Ä–≤–∏—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º sudo_password
          echo "Stopping old systemd service..."
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl stop devops-app 2>/dev/null || echo "Systemd service not running"
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl disable devops-app 2>/dev/null || echo "Systemd service already disabled"
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl daemon-reload 2>/dev/null || echo "Daemon reload not needed"
          
          echo "Docker is ready"
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
          echo "Logging into GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          echo "Cleaning up old containers..."
          docker stop devops-app 2>/dev/null || echo "No container to stop"
          docker rm devops-app 2>/dev/null || echo "No container to remove"
          
          # Pull –æ–±—Ä–∞–∑–∞ –∏–∑ registry (–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–µ–≥–∏)
          echo "Pulling Docker image..."
          IMAGE_BASE="ghcr.io/${{ github.repository }}"
          
          if docker pull "$IMAGE_BASE:docker-lab3"; then
            IMAGE_NAME="$IMAGE_BASE:docker-lab3"
            echo "Using image: $IMAGE_NAME"
          elif docker pull "$IMAGE_BASE:latest"; then
            IMAGE_NAME="$IMAGE_BASE:latest"
            echo "Using image: $IMAGE_NAME"
          else
            echo "No Docker image found in registry!"
            echo "Available images: https://github.com/${{ github.repository }}/pkgs/container/devops-lab2"
            exit 1
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          echo "Starting new container..."
          docker run -d \
            --name devops-app \
            --restart unless-stopped \
            -p 8181:8181 \
            -e FLASK_APP=app.py \
            -e FLASK_ENV=production \
            $IMAGE_NAME
          
          echo "Waiting for application to start..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          echo "Checking container status..."
          docker ps --filter "name=devops-app"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
          echo "Container logs (last 10 lines):"
          docker logs devops-app --tail 10
          
          # Health check —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
          echo "üîç Performing health check..."
          for i in {1..3}; do
            if curl -f http://localhost:8181; then
              echo "Docker deployment completed successfully!"
              echo "Application available at: http://app.tsyganova.course.prafdin.ru"
              echo "Running in Docker container"
              echo "Image: $IMAGE_NAME"
              exit 0
            else
              echo "Health check attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          echo "Application health check failed after 3 attempts!"
          echo "Debug information:"
          docker logs devops-app
          exit 1
