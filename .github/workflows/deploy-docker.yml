name: CD Pipeline with Docker Compose

on:
  release:
    types: [published]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main  # Ğ˜Ğ»Ğ¸ docker-lab4 Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ²Ğ°ÑˆĞµĞ¹ Ğ²ĞµÑ‚ĞºĞ¸
      
    - name: Deploy to server with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "ğŸš€ Starting Docker Compose deployment..."
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´
          echo "ğŸ“¥ Updating code..."
          cd /home/${{ secrets.SSH_USER }}/devops-lab4
          git fetch origin
          git reset --hard origin/main
          
          # Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² GitHub Container Registry
          echo "ğŸ”‘ Logging into GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚ĞµĞº
          echo "ğŸ§¹ Cleaning up old stack..."
          docker compose down --volumes --remove-orphans 2>/dev/null || echo "No stack to clean up"
          
          # Pull Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
          echo "â¬‡ï¸ Pulling Docker image..."
          IMAGE_NAME="ghcr.io/${{ github.repository }}:main"
          
          if ! docker pull "$IMAGE_NAME"; then
            echo "âš ï¸  Trying latest tag..."
            IMAGE_NAME="ghcr.io/${{ github.repository }}:latest"
            docker pull "$IMAGE_NAME" || echo "âš ï¸  Could not pull image, will build locally"
          fi
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚ĞµĞº
          echo "ğŸš€ Starting Docker Compose stack..."
          docker compose up -d
          
          echo "â³ Waiting for services to start..."
          sleep 15
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Checking stack status..."
          docker compose ps
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸
          echo "ğŸ“ Container logs:"
          docker compose logs --tail=10
          
          # Health check
          echo "ğŸ” Performing health check..."
          for i in {1..5}; do
            if curl -f http://localhost:8181; then
              echo ""
              echo "âœ… Docker Compose deployment completed successfully!"
              echo "ğŸŒ Application available at: http://app.tsyganova.course.prafdin.ru"
              echo "ğŸ³ Running with Docker Compose"
              echo "ğŸ’¾ Using SQLite database with persistent volume"
              echo "ğŸ“ˆ Check visits: http://app.tsyganova.course.prafdin.ru/visits"
              exit 0
            else
              echo "âš ï¸  Health check attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          echo "âŒ Application health check failed after 5 attempts!"
          echo "ğŸ› Debug information:"
          docker compose logs
          exit 1
