name: CD Pipeline with Docker Compose

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches: [ lab4 ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π —Å Docker Compose..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd /home/${{ secrets.SSH_USER }}/devops-lab4
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
          git fetch origin
          git reset --hard origin/lab4
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
          echo "üîê –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker-compose down 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ—Ç"
          
          # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑
          echo "üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑..."
          docker pull ghcr.io/${{ github.repository }}:latest
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Docker Compose
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Docker Compose..."
          GITHUB_USER=${{ github.repository_owner }} docker-compose up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
          docker-compose ps
          
          # Health check
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å..."
          for i in {1..5}; do
            if curl -f http://localhost:8181; then
              echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!"
              echo "üåê –î–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://app.tsyganova.course.prafdin.ru"
              echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π: http://app.tsyganova.course.prafdin.ru/visits"
              exit 0
            else
              echo "–ü–æ–ø—ã—Ç–∫–∞ $i/5 –Ω–µ —É–¥–∞–ª–∞—Å—å, –∂–¥–µ–º 5 —Å–µ–∫—É–Ω–¥..."
              sleep 5
            fi
          done
          
          echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å"
          echo "–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
          docker-compose logs
          exit 1
