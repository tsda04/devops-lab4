name: CD Pipeline

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "ðŸš€ Starting Docker Compose deployment..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          APP_DIR="/home/${{ secrets.SSH_USER }}/devops-lab4"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ docker-compose (Ð±ÐµÐ· Ð·Ð°Ð¼ÐµÐ½Ñ‹ volumes)
          echo "ðŸ“‹ Copying docker-compose files..."
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚ÐµÐº ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          if [ -f docker-compose.yml ]; then
            echo "â¹ï¸  Stopping existing stack..."
            docker-compose down || true
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ docker-compose.yml Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          cat > docker-compose.yml << 'EOF'
          version: '3.8'

          services:
            db:
              image: postgres:13-alpine
              environment:
                POSTGRES_DB: lab4db
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: postgres
              volumes:
                - postgres_data:/var/lib/postgresql/data
              networks:
                - app-network
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U postgres"]
                interval: 10s
                timeout: 5s
                retries: 5
              restart: unless-stopped

            web:
              image: ghcr.io/${{ github.repository }}:latest
              environment:
                DB_HOST: db
                DB_PORT: 5432
                DB_NAME: lab4db
                DB_USER: postgres
                DB_PASSWORD: postgres
              ports:
                - "8181:5000"
              depends_on:
                db:
                  condition: service_healthy
              networks:
                - app-network
              restart: unless-stopped

          volumes:
            postgres_data:

          networks:
            app-network:
              driver: bridge
          EOF
          
          # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
          echo "ðŸ” Logging into GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull Ð¾Ð±Ñ€Ð°Ð·Ð°
          echo "ðŸ“¥ Pulling Docker image..."
          docker-compose pull web
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÑ‚ÐµÐº
          echo "ðŸš€ Starting Docker Compose stack..."
          docker-compose up -d
          
          echo "â³ Waiting for services to start..."
          sleep 15
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          echo "ðŸ“Š Container status:"
          docker-compose ps
          
          # Health check
          echo "ðŸ” Health check..."
          for i in {1..5}; do
            if curl -f http://localhost:8181/health; then
              echo "âœ… Deployment successful!"
              echo "ðŸŒ Application available at: http://app.tsyganova.course.prafdin.ru"
              exit 0
            else
              echo "â³ Attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          echo "âŒ Health check failed!"
          echo "ðŸ“œ Logs from web service:"
          docker-compose logs web
          echo "ðŸ“œ Logs from db service:"
          docker-compose logs db
          exit 1
