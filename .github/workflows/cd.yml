name: CD Pipeline with Docker Compose

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.tag_name || 'main' }}
      
    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ Docker Compose..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          echo "ðŸ“ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ..."
          mkdir -p /home/${{ secrets.SSH_USER }}/devops-lab4
          cd /home/${{ secrets.SSH_USER }}/devops-lab4
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ docker-compose Ñ„Ð°Ð¹Ð» Ñ GitHub
          echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ docker-compose Ñ„Ð°Ð¹Ð»..."
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            web:
              image: ghcr.io/${{ github.repository }}:latest
              restart: always
              ports:
                - "8181:8181"
              depends_on:
                - db
              environment:
                - FLASK_ENV=production
              volumes:
                - app_data:/data
              networks:
                - app-network
          
            db:
              image: nouchka/sqlite3:latest
              restart: always
              volumes:
                - app_data:/data
              networks:
                - app-network
          
          volumes:
            app_data:
          
          networks:
            app-network:
              driver: bridge
          EOF
          
          echo "ðŸ“„ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ docker-compose.yml:"
          cat docker-compose.yml
          
          # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
          echo "ðŸ” Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
          docker-compose down 2>/dev/null || echo "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½ÐµÑ‚"
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
          echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹..."
          docker rmi ghcr.io/${{ github.repository }}:latest 2>/dev/null || echo "ÐžÐ±Ñ€Ð°Ð·Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð½ÐµÑ‚"
          
          # ÐŸÐ¾Ð´Ñ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð· (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ latest Ñ‚ÐµÐ³)
          echo "ðŸ“¦ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð·..."
          docker pull ghcr.io/${{ github.repository }}:latest
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Docker Compose..."
          docker-compose up -d
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          sleep 15
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
          docker-compose ps
          
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° web:"
          docker-compose logs --tail=10 web
          
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° db:"
          docker-compose logs --tail=5 db
          
          # Health check
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ..."
          for i in {1..10}; do
            echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° $i/10..."
            if curl -f http://localhost:8181; then
              echo ""
              echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾!"
              echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://app.tsyganova.course.prafdin.ru"
              echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ÑÐµÑ‰ÐµÐ½Ð¸Ð¹: http://app.tsyganova.course.prafdin.ru/visits"
              echo ""
              echo "ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ñ…:"
              echo "1. Web ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ (Flask): $(docker-compose ps web | grep Up)"
              echo "2. DB ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ (SQLite): $(docker-compose ps db | grep Up)"
              echo "3. Ð¡ÐµÑ‚ÑŒ: $(docker network ls | grep devops-lab4)"
              echo "4. Volume: $(docker volume ls | grep devops-lab4)"
              exit 0
            else
              echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° $i Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ, Ð¶Ð´ÐµÐ¼ 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹..."
              sleep 3
            fi
          done
          
          echo "âŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¾ÑÑŒ Ð¿Ð¾ÑÐ»Ðµ 10 Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº"
          echo ""
          echo "ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:"
          echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹ Ð»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹:"
          docker ps -a | grep devops-lab4
          echo ""
          echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸:"
          docker-compose logs
          echo ""
          echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÑ‚ÑŒ:"
          docker network inspect devops-lab4_app-network 2>/dev/null || echo "Ð¡ÐµÑ‚ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          echo ""
          echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ volume:"
          docker volume inspect devops-lab4_app-data 2>/dev/null || echo "Volume Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          exit 1
