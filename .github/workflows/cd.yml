name: CD Pipeline

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "ğŸš€ Starting Docker Compose deployment..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
          APP_DIR="/home/${{ secrets.SSH_USER }}/devops-lab4"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ»
          cat > .env << 'EOF'
          DB_HOST=db
          DB_PORT=5432
          DB_NAME=lab4db
          DB_USER=postgres
          DB_PASSWORD=postgres
          POSTGRES_DB=lab4db
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          EOF
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ docker-compose.yml
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            db:
              image: postgres:15-alpine
              environment:
                POSTGRES_DB: lab4db
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: postgres
              volumes:
                - postgres_data:/var/lib/postgresql/data
              networks:
                - app-network
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U postgres"]
                interval: 10s
                timeout: 5s
                retries: 10
              restart: unless-stopped
          
            web:
              image: ghcr.io/${{ github.repository }}:latest
              environment:
                DB_HOST: db
                DB_PORT: 5432
                DB_NAME: lab4db
                DB_USER: postgres
                DB_PASSWORD: postgres
              ports:
                - "8181:5000"
              depends_on:
                db:
                  condition: service_healthy
              networks:
                - app-network
              restart: unless-stopped
          
          volumes:
            postgres_data:
          
          networks:
            app-network:
              driver: bridge
          EOF
          
          # Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² GitHub Container Registry
          echo "ğŸ” Logging into GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
          echo "ğŸ§¹ Cleaning up old containers..."
          docker-compose down --volumes --remove-orphans 2>/dev/null || true
          
          # Pull Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
          echo "ğŸ“¥ Pulling Docker image..."
          docker-compose pull web
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑÑ‚ĞµĞº
          echo "ğŸš€ Starting Docker Compose stack..."
          docker-compose up -d
          
          echo "â³ Waiting for services to start (60 seconds)..."
          sleep 60
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Container status:"
          docker-compose ps
          
          echo "ğŸ“œ Checking logs..."
          docker-compose logs --tail=20 web
          docker-compose logs --tail=10 db
          
          # Health check Ñ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Ğ¼Ğ¸
          echo "ğŸ” Health check (with retries)..."
          MAX_RETRIES=10
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            DB_HEALTH=$(docker-compose exec -T db pg_isready -U postgres 2>/dev/null | grep "accepting connections" || echo "not ready")
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
            if curl -s -f http://localhost:8181/health > /dev/null; then
              echo "âœ… Application health check passed!"
              echo "âœ… Database status: $DB_HEALTH"
              
              # Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°Ñ…
              echo "ğŸ“¦ Running containers:"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              
              echo "ğŸ‰ Deployment successful!"
              echo "ğŸŒ Application available at: http://app.tsyganova.course.prafdin.ru"
              echo "ğŸ”— Health check: http://app.tsyganova.course.prafdin.ru/health"
              exit 0
            else
              echo "â³ Health check failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts!"
          echo "ğŸ” Debug information:"
          echo "=== Web container logs ==="
          docker-compose logs web
          echo "=== DB container logs ==="
          docker-compose logs db
          echo "=== Network information ==="
          docker network inspect devops-lab4_app-network || echo "Network not found"
          exit 1
