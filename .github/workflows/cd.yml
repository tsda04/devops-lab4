name: CD Pipeline with Docker Compose

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.tag_name || 'main' }}
      
    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: course.prafdin.ru
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2467
        script: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          echo "ðŸ“Š ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹: Flask + PostgreSQL"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          echo "ðŸ“ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ..."
          mkdir -p /home/${{ secrets.SSH_USER }}/devops-lab4
          cd /home/${{ secrets.SSH_USER }}/devops-lab4
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SQL Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð‘Ð”
          echo "ðŸ—„ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ init-db.sql..."
          cat > init-db.sql << 'SQL_EOF'
          -- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          CREATE DATABASE appdb;
          
          -- Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
          CREATE USER appuser WITH ENCRYPTED PASSWORD 'apppassword';
          
          -- Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
          GRANT ALL PRIVILEGES ON DATABASE appdb TO appuser;
          
          -- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          \c appdb
          
          -- Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° ÑÑ…ÐµÐ¼Ñ‹
          GRANT ALL ON SCHEMA public TO appuser;
          SQL_EOF
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ docker-compose Ñ„Ð°Ð¹Ð»
          echo "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ docker-compose.yml..."
          cat > docker-compose.yml << 'COMPOSE_EOF'
          version: '3.8'
          
          services:
            web:
              image: ghcr.io/${{ github.repository }}:latest
              restart: always
              ports:
                - "8181:8181"
              depends_on:
                db:
                  condition: service_healthy
              environment:
                - FLASK_ENV=production
                - DB_HOST=db
                - DB_PORT=5432
                - DB_NAME=appdb
                - DB_USER=appuser
                - DB_PASSWORD=apppassword
              networks:
                - app-network
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          
            db:
              image: postgres:15-alpine
              restart: always
              environment:
                - POSTGRES_DB=appdb
                - POSTGRES_USER=appuser
                - POSTGRES_PASSWORD=apppassword
                - POSTGRES_INITDB_ARGS=--encoding=UTF-8
              volumes:
                - postgres_data:/var/lib/postgresql/data
                - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
              networks:
                - app-network
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U appuser -d appdb"]
                interval: 10s
                timeout: 5s
                retries: 5
          
          volumes:
            postgres_data:
          
          networks:
            app-network:
              driver: bridge
          COMPOSE_EOF
          
          echo "ðŸ“„ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ docker-compose.yml:"
          cat docker-compose.yml
          
          # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
          echo "ðŸ” Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry..."
          echo "${{ secrets.GITHUBTOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ volume)
          echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
          docker-compose down 2>/dev/null || echo "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½ÐµÑ‚"
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð· web Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð· web..."
          docker rmi ghcr.io/${{ github.repository }}:latest 2>/dev/null || echo "ÐžÐ±Ñ€Ð°Ð·Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð½ÐµÑ‚"
          
          # ÐŸÐ¾Ð´Ñ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð· web Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          echo "ðŸ“¦ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð· web Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          docker pull ghcr.io/${{ github.repository }}:latest
          
          # ÐŸÐ¾Ð´Ñ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· PostgreSQL
          echo "ðŸ˜ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· PostgreSQL..."
          docker pull postgres:15-alpine
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Docker Compose
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Docker Compose..."
          docker-compose up -d
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (60 ÑÐµÐºÑƒÐ½Ð´)..."
          sleep 60
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
          docker-compose ps
          
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° web:"
          docker-compose logs --tail=20 web
          
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° db:"
          docker-compose logs --tail=10 db
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health status
          echo "ðŸ©º ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health status ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          echo "Web health: $(docker inspect --format='{{.State.Health.Status}}' devops-lab4-web 2>/dev/null || echo 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½')"
          echo "DB health: $(docker inspect --format='{{.State.Health.Status}}' devops-lab4-db 2>/dev/null || echo 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½')"
          
          # Health check Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          for i in {1..15}; do
            echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° $i/15..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8181/health || true)
            if [ "$RESPONSE" = "200" ]; then
              DB_RESPONSE=$(curl -s http://localhost:8181/db-status | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
              if [ "$DB_RESPONSE" = "connected" ]; then
                echo ""
                echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾!"
                echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°!"
                echo ""
                echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://app.tsyganova.course.prafdin.ru"
                echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ÑÐµÑ‰ÐµÐ½Ð¸Ð¹: http://app.tsyganova.course.prafdin.ru/visits"
                echo "ðŸ› ï¸  Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð‘Ð”: http://app.tsyganova.course.prafdin.ru/db-status"
                echo ""
                echo "ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ñ…:"
                docker-compose ps
                echo ""
                echo "ðŸ’¾ Volume:"
                docker volume ls | grep devops-lab4
                echo ""
                echo "ðŸŒ Ð¡ÐµÑ‚ÑŒ:"
                docker network ls | grep devops-lab4
                echo ""
                echo "ðŸ³ ÐžÐ±Ñ€Ð°Ð·Ñ‹:"
                docker images | grep -E "(ghcr.io|postgres)"
                exit 0
              else
                echo "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚, Ð½Ð¾ Ð‘Ð” Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð–Ð´ÐµÐ¼..."
              fi
            fi
            echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° $i Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ (ÐºÐ¾Ð´: $RESPONSE), Ð¶Ð´ÐµÐ¼ 5 ÑÐµÐºÑƒÐ½Ð´..."
            sleep 5
          done
          
          echo "âŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¾ÑÑŒ Ð¿Ð¾ÑÐ»Ðµ 15 Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº"
          echo ""
          echo "ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:"
          echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹ Ð»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹:"
          docker ps -a
          echo ""
          echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ web:"
          docker-compose logs web
          echo ""
          echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ db:"
          docker-compose logs db
          echo ""
          echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð»Ð¸ Ð¿Ð¾Ñ€Ñ‚ 8181:"
          netstat -tlnp | grep 8181 || echo "ÐŸÐ¾Ñ€Ñ‚ 8181 Ð½Ðµ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ÑÑ"
          echo ""
          echo "5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð»Ð¸ Ð¿Ð¾Ñ€Ñ‚ 5432:"
          netstat -tlnp | grep 5432 || echo "ÐŸÐ¾Ñ€Ñ‚ 5432 Ð½Ðµ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ÑÑ"
          echo ""
          echo "6. ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº PostgreSQL Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° web:"
          docker exec devops-lab4-web pg_isready -h db -U appuser -d appdb 2>/dev/null || echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº Ð‘Ð”"
          echo ""
          echo "7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ volume:"
          docker volume inspect devops-lab4_postgres_data 2>/dev/null || echo "Volume Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          exit 1
